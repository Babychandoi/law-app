user  nginx;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    # ========================
    # SSL CONFIG (GLOBAL)
    # ========================
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # ========================
    # HTTP â†’ HTTPS REDIRECT
    # ========================
    server {
        listen 80;
        server_name
            luatpoip.com
            www.luatpoip.com
            api.luatpoip.com
            minio.luatpoip.com
            minio-console.luatpoip.com;

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # =====================================================
    # FRONTEND (React / Vue / SPA)
    # =====================================================
    server {
        listen 443 ssl;
        server_name luatpoip.com www.luatpoip.com;

        ssl_certificate     /etc/letsencrypt/live/luatpoip.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/luatpoip.com/privkey.pem;

        location / {
            proxy_pass http://law-app-frontend:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }
    }

    # =====================================================
    # BACKEND API + WEBSOCKET + STOMP (/ws)
    # =====================================================
    server {
        listen 443 ssl;
        server_name api.luatpoip.com;

        ssl_certificate     /etc/letsencrypt/live/luatpoip.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/luatpoip.com/privkey.pem;

        # -------- REST API --------
        location / {
            proxy_pass http://law-app-backend:8080;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }

        # -------- WebSocket + STOMP (/ws) --------
       	location /ws/ {
    	    proxy_pass http://law-app-backend:8080;
    	    proxy_http_version 1.1;

   	    proxy_set_header Upgrade $http_upgrade;
   	    proxy_set_header Connection "upgrade";

   	    proxy_set_header Host $host;
   	    proxy_set_header X-Real-IP $remote_addr;
   	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
   	    proxy_set_header X-Forwarded-Proto https;

   	    proxy_read_timeout 86400;
	}

    }

    	# =====================================================
	# MINIO API (FILE UPLOAD / DOWNLOAD)
	# =====================================================
    server {
    	listen 443 ssl;
    	server_name minio.luatpoip.com;

    	ssl_certificate     /etc/letsencrypt/live/luatpoip.com/fullchain.pem;
    	ssl_certificate_key /etc/letsencrypt/live/luatpoip.com/privkey.pem;

    	# ðŸ”´ Báº®T BUá»˜C cho upload
    	client_max_body_size 500m;

    	location / {
        	proxy_pass http://minio:9000;

        	proxy_http_version 1.1;
        	proxy_set_header Host $host;
        	proxy_set_header X-Forwarded-Proto https;
        	proxy_set_header X-Real-IP $remote_addr;

        	# ðŸ”´ TrÃ¡nh timeout khi upload file lá»›n
        	proxy_connect_timeout 300s;
        	proxy_send_timeout    300s;
        	proxy_read_timeout    300s;
        	send_timeout          300s;
    	}
    }
	# =====================================================
	# MINIO CONSOLE (ADMIN UI)
	# =====================================================
    server {
    	listen 443 ssl;
    	server_name minio-console.luatpoip.com;

    	ssl_certificate     /etc/letsencrypt/live/luatpoip.com/fullchain.pem;
    	ssl_certificate_key /etc/letsencrypt/live/luatpoip.com/privkey.pem;

    	client_max_body_size 20m;

    	location / {
        	proxy_pass http://minio:9001;

        	proxy_http_version 1.1;
        	proxy_set_header Host $host;
        	proxy_set_header X-Forwarded-Proto https;
        	proxy_set_header X-Real-IP $remote_addr;
    	}
    }
	
}
